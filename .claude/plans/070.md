# Plan: 070

Captured: 2025-09-17T13:16:59.148Z

# Fix CI Test Failures via Dependency Injection

## Problem
- `index.test.ts` uses `mock.module('./coderabbit')` which pollutes global module cache
- This mock leaks into `coderabbit.test.ts` when tests run in CI
- The mock returns "CodeRabbit review content" instead of letting the real tests run

## Solution
Add dependency injection to `performCodeReview` so tests can inject mocks directly without using `mock.module`:

1. **Update `src/lib/code-review/index.ts`**:
   - Add optional `deps` parameter to `performCodeReview` 
   - Accept `performClaudeReview` and `performCodeRabbitReview` as injectable dependencies
   - Default to real implementations if not provided

2. **Update `src/lib/code-review/index.test.ts`**:
   - Remove ALL `mock.module()` calls
   - Pass mock functions via deps parameter instead
   - This ensures no global module pollution

## Benefits
- Consistent with existing DI pattern used throughout codebase
- No global side effects or test pollution
- Tests remain isolated and predictable
- Same pattern already working in `coderabbit.test.ts`