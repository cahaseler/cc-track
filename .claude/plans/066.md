# Plan: 066

Captured: 2025-09-17T00:22:54.261Z

## Plan: Make cc-track Lint-Agnostic with Built-in Support for Biome and ESLint

### Investigation Results: Biome-Specific Hardcoded Assumptions

After investigating the codebase, I found that while the configuration system appears to support any lint command, there are indeed several hardcoded assumptions specific to Biome that need to be fixed:

### Issues Found:

1. **`src/lib/validation.ts` - runBiomeCheck function (lines 91-130)**:
   - Function name itself is "runBiomeCheck" (should be generic like "runLintCheck")
   - Line 98: Hardcoded `bunx biome check --write` for auto-formatting
   - Line 109: Adds `--error-on-warnings` flag specifically for Biome
   - Line 120: Parses Biome-specific output format "diagnostic"
   - Variable names reference "biome" throughout

2. **`src/hooks/edit-validation.ts` - runBiomeCheck function (lines 178-219)**:
   - Function name is "runBiomeCheck" (should be generic)
   - Line 192: Adds `--reporter=compact` flag specifically for Biome
   - Line 208-213: Parses Biome-specific compact output format

3. **`src/commands/prepare-completion.ts` (lines 281-293)**:
   - Line 283: Messages reference "Biome issues" specifically
   - Line 292: Hardcoded advice to use `bunx biome check --write`

4. **Variable/property naming throughout**:
   - `ValidationResult` interface has property called "biome"
   - Config properties use "biome" in variable names

### Detailed Fix Plan:

1. **Update configuration structure** to support tool detection:
   ```typescript
   // In track.config.json
   "lint": {
     "enabled": true,
     "tool": "biome",  // "biome" | "eslint" | "custom"
     "command": "bunx biome check",
     "autoFixCommand": "bunx biome check --write",  // optional
     "customParser": "path/to/parser.js"  // only needed for tool: "custom"
   }
   ```

2. **Create lint parser abstraction** (`src/lib/lint-parsers.ts`):
   ```typescript
   interface LintParser {
     parseOutput(output: string, filePath?: string): ParsedLintResult;
     getAutoFixCommand(baseCommand: string): string | undefined;
   }
   
   class BiomeParser implements LintParser {
     // Parse "X diagnostics" format
     // Parse compact reporter format for file-specific errors
     // Return structured errors with line numbers
   }
   
   class ESLintParser implements LintParser {
     // Parse ESLint stylish or compact format
     // Extract error/warning counts
     // Handle various ESLint output formats
   }
   
   class GenericParser implements LintParser {
     // Simple line-based error matching
     // Fallback for unknown tools
   }
   ```

3. **Refactor `src/lib/validation.ts`**:
   - **Line 93**: Rename function `runBiomeCheck` → `runLintCheck`
   - **Line 95-101**: Replace hardcoded auto-formatter with:
     ```typescript
     if (lintConfig?.autoFixCommand) {
       try {
         execSync(lintConfig.autoFixCommand, { cwd: projectRoot });
       } catch {
         // Auto-fix might fail, continue to check
       }
     }
     ```
   - **Line 107-109**: Remove automatic `--error-on-warnings` addition
   - **Line 119-127**: Replace Biome-specific parsing with parser abstraction:
     ```typescript
     const parser = getLintParser(lintConfig?.tool || 'biome');
     const result = parser.parseOutput(output);
     ```
   - Update all variable names: `biomeConfig` → `lintConfig`, `biomeCheck` → `lintCheck`

4. **Refactor `src/hooks/edit-validation.ts`**:
   - **Line 178**: Rename function `runBiomeCheck` → `runLintCheck`
   - **Line 192**: Remove hardcoded `--reporter=compact`, use command as-is
   - **Line 208-213**: Replace Biome-specific parsing with:
     ```typescript
     const parser = getLintParser(config.lint?.tool || 'biome');
     const errors = parser.parseOutput(output, filePath);
     ```
   - Update function signature and all references

5. **Update ValidationResult interface** (multiple files):
   - Change `biome?: { ... }` to `lint?: { ... }`
   - Keep the same structure (passed, errors, issueCount)
   - Update all references in:
     - `src/lib/validation.ts`
     - `src/commands/prepare-completion.ts`
     - `src/commands/complete-task.ts`
     - Test files

6. **Update user-facing messages in `src/commands/prepare-completion.ts`**:
   - **Line 283**: Change "Biome issues" to "Linting issues"
   - **Line 292**: Generate tool-specific fix advice:
     ```typescript
     const lintTool = config.lint?.tool || 'biome';
     const fixAdvice = {
       biome: 'Fix with `bunx biome check --write`',
       eslint: 'Fix with `npx eslint --fix`',
       custom: config.lint?.autoFixCommand 
         ? `Fix with \`${config.lint.autoFixCommand}\``
         : 'Fix linting issues manually'
     };
     messages.push(`**Action:** ${fixAdvice[lintTool]}.\n`);
     ```

7. **Backward compatibility handling**:
   - In config loading, detect old format (just `command` string)
   - If old format detected, convert to new format assuming Biome:
     ```typescript
     if (typeof config.lint === 'object' && !config.lint.tool) {
       config.lint.tool = 'biome'; // Assume Biome for existing configs
     }
     ```

8. **Update default configurations**:
   - `src/lib/config.ts`: Update default lint config structure
   - Template files: Update to show new config format
   - Documentation: Add examples for ESLint configuration

9. **Add comprehensive tests**:
   - Test Biome output parsing with various error formats
   - Test ESLint output parsing (stylish, compact formats)
   - Test generic parser fallback
   - Test backward compatibility with old configs
   - Test both validation.ts and edit-validation.ts with different tools

10. **Update documentation**:
   - README: Show examples for both Biome and ESLint configuration
   - Comments in code: Update to be tool-agnostic
   - Config template: Include commented examples for different tools

### Implementation Order:
1. Create lint-parsers.ts with all three parser implementations
2. Update config types and interfaces
3. Refactor validation.ts to use parsers
4. Refactor edit-validation.ts to use parsers
5. Update prepare-completion.ts messages
6. Add backward compatibility logic
7. Update all tests
8. Update documentation and templates

This approach maintains full detail while supporting Biome and ESLint as first-class citizens, with the flexibility to support other tools through the custom parser option.