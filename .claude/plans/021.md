# Plan: 021

Captured: 2025-09-10T20:55:16.027Z

## Plan: Improve /complete-task Command with Smart Script

### Overview
Create a TypeScript script that handles all programmatic aspects of task completion safely, with intelligent error handling. The script runs once and reports what it accomplished, allowing Claude to handle any special cases.

### Implementation Details

#### 1. Create Script: `.claude/scripts/complete-task.ts`

**Core Operations (in order):**
1. **Validate Prerequisites:**
   - Check if there's an active task in CLAUDE.md
   - Extract task ID and path
   - Verify task file exists and is "in_progress"

2. **Update Task Status:**
   - Change status to "completed" in task file
   - Add completion date to "Current Focus" section
   - Keep all existing content intact

3. **Update CLAUDE.md:**
   - Replace active task with `@.claude/no_active_task.md`

4. **Update no_active_task.md:**
   - Add the completed task to the list
   - Extract task title from task file

5. **Run Validation Checks:**
   - Run `bunx tsc --noEmit` (capture results)
   - Run `bunx biome check` (capture results)
   - Continue even if these fail (just report)

6. **Git Operations (if safe):**
   - Check for WIP commits pattern
   - If found and safe to squash:
     - Get task ID for commit message
     - Squash WIP commits
   - If not safe (mixed commits, no WIPs, etc.):
     - Report current git status
     - Let Claude decide

7. **Handle Branching (if enabled):**
   - Check if git_branching is enabled
   - Look for branch info in task file
   - If found, attempt merge to default branch
   - Report success/failure

**Output Format (JSON):**
```json
{
  "success": true,
  "taskId": "TASK_020",
  "taskTitle": "PostToolUse Hook for Edit Validation",
  "updates": {
    "taskFile": "updated",
    "claudeMd": "updated", 
    "noActiveTask": "updated"
  },
  "validation": {
    "typescript": "0 errors",
    "biome": "0 issues"
  },
  "git": {
    "squashed": true,
    "commitMessage": "TASK_020: PostToolUse Hook for Edit Validation",
    "branchMerged": false,
    "notes": "No branch info found"
  },
  "warnings": [],
  "filesChanged": ["src/foo.ts", "lib/bar.ts"]
}
```

**Safety Features:**
- Never force operations
- Check before modifying (e.g., verify task is in_progress)
- Graceful handling of missing/malformed data
- Clear reporting of what couldn't be done
- No interactive prompts (skip operations that would require them)

#### 2. Update Command: `.claude/commands/complete-task.md`

```markdown
---
allowed-tools: Bash(bun run:*), TodoWrite, mcp__private-journal__process_thoughts, Edit, Read
description: Complete the current active task with reflection and documentation
---

## Automated Completion Results
!`bun run .claude/scripts/complete-task.ts`

## Your Task

Based on the completion results above:

1. **Reflect in Journal** about the task:
   - Technical insights learned
   - Challenges faced and solutions
   - Patterns discovered
   - Collaboration notes

2. **Handle Any Issues:**
   - If validation errors: decide if they need fixing
   - If git operations failed: handle manually if needed
   - Document any technical debt identified

3. **Update Key Documentation:**
   - Add completion summary to the task file
   - Update progress_log.md with completion entry
   - Add significant decisions to decision_log.md
   - Update system_patterns.md if new patterns emerged

4. **Provide Summary to User:**
   - What was delivered
   - Key achievements
   - Any issues or follow-up items
   - Next steps recommendation
```

#### 3. Script Behavior Examples

**Normal Case:**
- Task in progress → completed ✓
- CLAUDE.md updated ✓
- WIP commits squashed ✓
- Reports success

**Mixed Commits Case:**
- Task in progress → completed ✓
- CLAUDE.md updated ✓
- Git has mixed WIP and regular commits
- Reports: "Git has mixed commits, manual review recommended"
- Claude can then decide whether to squash manually

**No Git Changes Case:**
- Task in progress → completed ✓
- CLAUDE.md updated ✓
- No commits to squash
- Reports: "No git changes found for this task"

**Validation Errors Case:**
- Task in progress → completed ✓
- CLAUDE.md updated ✓
- TypeScript has 3 errors
- Reports errors, continues with completion
- Claude decides if errors need fixing first

### Benefits

1. **Single Execution:** No check mode needed - just run and see results
2. **Safe by Default:** Won't break on edge cases, just reports status
3. **Clear Delegation:** Script does mechanical work, Claude handles judgment calls
4. **Fast:** All updates in one script execution
5. **Reliable:** CLAUDE.md always gets updated (main pain point solved)

### Files to Create/Modify

1. **Create:** `.claude/scripts/complete-task.ts` - Smart completion script
2. **Update:** `.claude/commands/complete-task.md` - Simplified command using script
3. **Update:** `.claude/backlog.md` - Remove the now-addressed item

This approach is simpler, safer, and gives Claude the flexibility to handle edge cases with human judgment.