# Plan: 051

Captured: 2025-09-15T01:10:44.683Z

## Branch Protection Implementation Plan (Extending Existing Hook)

### Overview
Rename and extend the existing `task-validation` PreToolUse hook to become a more generic `pre-tool-validation` hook that handles both task file validation and branch protection.

### Implementation Steps

1. **Rename Hook Files**
   - Rename `task-validation.ts` → `pre-tool-validation.ts`
   - Rename `task-validation.test.ts` → `pre-tool-validation.test.ts`
   - Update all imports and references

2. **Update Configuration Structure**
   - Rename `task_validation` to `pre_tool_validation` in config
   - Add sub-configurations:
     ```json
     "pre_tool_validation": {
       "enabled": true,
       "task_validation": {
         "enabled": true,
         "description": "Validates task file edits"
       },
       "branch_protection": {
         "enabled": false,
         "description": "Blocks edits on protected branches",
         "protected_branches": ["main", "master"],
         "allow_gitignored": true
       }
     }
     ```

3. **Extend Hook Logic**
   - Add branch protection check BEFORE task validation
   - For Edit/Write/MultiEdit tools:
     1. Check if branch protection is enabled
     2. Get current branch using GitHelpers
     3. If on protected branch, check gitignore status
     4. Block with clear message if not allowed
     5. Continue to task validation if allowed
   - Keep existing task validation logic intact

4. **Update Hook Dispatcher**
   - Change `'task-validation'` to `'pre-tool-validation'` in determineHookType
   - Update hookHandlers mapping
   - Import renamed module

5. **Update no_active_task.md**
   - Add conditional section when branch protection is enabled
   - Explain that edits are blocked on main branch
   - Guide to create feature branches
   - Note that gitignored files are allowed

6. **Write Tests**
   - Test branch protection blocking on main
   - Test allowing edits on feature branches
   - Test gitignored file exemption
   - Test configuration backwards compatibility
   - Ensure existing task validation tests still pass

7. **Documentation Updates**
   - Update decision log with rationale
   - Update system_patterns.md
   - Add configuration example

### Benefits of This Approach
- Single PreToolUse hook for all validation logic
- Cleaner architecture (one validation pipeline)
- Easier to maintain and extend
- Backwards compatible with existing configs
- Logical grouping of related validations