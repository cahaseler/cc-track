# Plan: 053

Captured: 2025-09-15T02:06:37.808Z

## Plan: Enhance capture-plan hook to handle active tasks and set in_progress status

### Problem Analysis
1. **Item 5**: When there's already an active task, capture-plan creates a new task anyway, potentially causing confusion
2. **Item 7**: New tasks are created with "planning" status but should be "in_progress" to match Claude's actual work state

### Implementation Plan

#### 1. Check for Active Task Before Creating New One
- Use `ClaudeMdHelpers.hasActiveTask()` to detect if a task is already active
- If active task exists:
  - Return a systemMessage instructing Claude to update the existing task file
  - Include the task ID in the message so Claude knows which file to update
  - Suggest completing current task first if this was meant to be a new task
- If no active task, proceed with normal task creation

#### 2. Update Task Status to in_progress
- Change the hardcoded "planning" status in `generateEnrichmentPrompt()` to "in_progress"
- This better reflects that Claude will immediately start working on the task
- Update the prompt template to use "in_progress" instead of "planning"

#### 3. Add Tests
- Test active task detection blocking new task creation
- Test the systemMessage returned when active task exists
- Test that new tasks are created with "in_progress" status
- Ensure existing tests still pass with status change

### Files to Modify
1. `src/hooks/capture-plan.ts`:
   - Add active task check at the beginning of `capturePlanHook()`
   - Update `generateEnrichmentPrompt()` to use "in_progress" status
   - Return appropriate systemMessage when active task exists

2. `src/hooks/capture-plan.test.ts`:
   - Add test for active task detection
   - Update existing tests to expect "in_progress" status
   - Add test for the blocking behavior with appropriate message

### Expected Behavior After Changes
- When planning mode is exited with an active task: Claude gets a message to update the existing task file
- When planning mode is exited without active task: New task created with "in_progress" status
- Clear messaging guides users on what to do (complete task or clear active task)

### Benefits
- Prevents accidental task proliferation
- Keeps task status accurate to actual work state
- Clearer workflow for both Claude and users
- Better task management discipline