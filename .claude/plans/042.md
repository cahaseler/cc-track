# Plan: 042

Captured: 2025-09-13T21:57:41.809Z

## Plan: Create Git Diff Summary Utility Using Claude SDK

I'll create a new utility function that uses our existing Claude SDK wrapper to summarize git diffs, following the established patterns for dependency injection and testing.

### Files to Create/Modify:

1. **src/lib/diff-summary.ts** - New utility module
   - Export `DiffSummary` class with constructor injection for dependencies
   - Export `DiffSummaryInterface` for dependency injection in other modules
   - Method `summarizeDiff(diff: string)` - summarize a single diff
   - Method `summarizeDiffs(diffs: string[])` - summarize multiple diffs
   - Use existing ClaudeSDK.prompt with appropriate model (haiku for simple summaries)
   - Include proper error handling and logging

2. **src/lib/diff-summary.test.ts** - Unit tests with mocked dependencies
   - Test successful single diff summary
   - Test multiple diffs summary
   - Test error handling (SDK failures, timeouts)
   - Test empty/invalid input handling
   - Use dependency injection pattern with mock ClaudeSDK and logger
   - Follow existing test patterns from git-helpers.test.ts

3. **src/lib/diff-summary.integration.test.ts** - Integration test with real SDK
   - Create a temporary test that uses the real ClaudeSDK
   - Test with a small, real git diff
   - Mark test as integration test (can be skipped in CI)
   - Include cleanup and proper error handling

### Implementation Details:

**DiffSummary Class Structure:**
```typescript
export interface DiffSummaryInterface {
  summarizeDiff(diff: string): Promise<string>;
  summarizeDiffs(diffs: string[]): Promise<string>;
}

export class DiffSummary implements DiffSummaryInterface {
  constructor(
    private claudeSDK?: ClaudeSDKInterface,
    private logger?: ReturnType<typeof createLogger>
  )
}
```

**Key Patterns to Follow:**
- Use optional dependency injection with defaults (like GitHelpers)
- Lazy load ClaudeSDK if not provided (ensureClaudeSDK pattern)
- Use haiku model for cost efficiency (summaries don't need complex reasoning)
- Add timeout of 15000ms for API calls
- Truncate very large diffs (>3000 chars) before sending to API
- Log all operations with the logger
- Return concise summaries focused on "what changed" not "how"

**Prompt Engineering:**
- Request structured, bullet-point summaries
- Focus on user-visible changes and functionality
- Group related changes together
- Ignore formatting/whitespace changes
- Keep summaries under 500 chars per diff

**Testing Approach:**
- Mock ClaudeSDK.prompt to return predictable summaries
- Test edge cases: empty diffs, huge diffs, malformed diffs
- Verify truncation logic works correctly
- Ensure proper error propagation
- Integration test validates real SDK behavior without mocks

This follows all existing patterns from the codebase and provides a reusable utility for summarizing git diffs throughout the cc-track system.