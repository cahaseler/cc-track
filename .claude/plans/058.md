# Plan: 058

Captured: 2025-09-15T19:36:13.186Z

## Fix Code Review Error: Convert String Prompts to AsyncIterable Format

### Problem
The code review feature is failing with the error "canUseTool callback requires --input-format stream-json" because we're passing string prompts to `query()` when using `canUseTool`. According to the Claude Code TypeScript SDK documentation, when using `canUseTool`, the prompt must be an `AsyncIterable<SDKUserMessage>`.

### Affected Code
1. **src/lib/claude-sdk.ts - performCodeReview()** (line 428): Uses string prompt with canUseTool
2. **src/hooks/capture-plan.ts - task enrichment** (line 216): Uses string prompt with canUseTool

### Solution
Create a helper function to convert string prompts to the required streaming format, then update both affected functions to use it.

### Implementation Steps
1. Add a helper function in `src/lib/claude-sdk.ts` to convert strings to AsyncIterable<SDKUserMessage>
2. Update `performCodeReview()` to use the streaming format
3. Update capture-plan hook's task enrichment to use the streaming format
4. Test the fix by running `/prepare-completion` on a task with code review enabled

### Code Changes Required
- Add `createMessageStream()` helper function
- Modify `performCodeReview()` to use `prompt: createMessageStream(p)` instead of `prompt: p`
- Modify capture-plan hook to use the same pattern
- Import the necessary SDKUserMessage type from '@anthropic-ai/claude-code'

This will fix the immediate error and allow code reviews to work properly again.