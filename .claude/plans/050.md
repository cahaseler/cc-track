# Plan: 050

Captured: 2025-09-15T00:50:57.914Z

## Plan: Move All Documentation Updates to Prepare Phase

### Problem
Currently, documentation updates are split between two phases:
- **Prepare phase**: Task file, decision log, system patterns
- **Complete phase**: Progress log updates, backlog clearing

This causes issues when on feature branches because the complete-task command switches back to main after creating the PR, then prompts for documentation updates that would create changes on main.

### Solution
Consolidate ALL documentation updates into the prepare-completion phase, including:
1. Progress log updates
2. Backlog item clearing (if the task came from backlog)

### Implementation Steps

1. **Update prepare-completion.ts**:
   - Add prompts for progress log updates after the existing documentation prompts
   - Add prompts to check and clear related backlog items
   - Keep existing prompts for task file, decision log, and system patterns

2. **Update complete-task.ts**:
   - Remove the post-completion documentation update prompts (lines ~494-500)
   - Keep PR enhancement prompts
   - Focus only on final summary reporting

### Benefits
- All documentation happens BEFORE branch switching
- No merge conflicts from updating docs on main after PR creation
- Cleaner separation: prepare = validation + docs, complete = git operations + PR
- The workflow itself will serve as the test when we complete this task

### Files to Modify
- `src/commands/prepare-completion.ts` - Add progress log and backlog prompts
- `src/commands/complete-task.ts` - Remove documentation prompts
- Update backlog to mark this item as addressed

Captured: 2025-09-15T00:11:15.553Z

## Fix Stop-Review Hook Max Turns Error

I've found the issue in the stop-review hook. The hook is calling the Claude SDK without specifying a `maxTurns` value, which defaults to 1. This is causing the "error_max_turns" issue when the review needs more than one turn to complete properly.

### The Fix

In `src/hooks/stop-review.ts` at line 566, I need to add `maxTurns: 5` to the options:

**Current code:**
```typescript
const response = await claudeSDK.prompt(prompt, model, { timeoutMs });
```

**Fixed code:**
```typescript
const response = await claudeSDK.prompt(prompt, model, { timeoutMs, maxTurns: 5 });
```

This simple change will allow the Claude SDK to use up to 5 turns if needed for the review, which should resolve the error_max_turns issue that's been occurring.

The change is minimal and follows the same pattern used in other hooks like pre-compact (which uses maxTurns: 20) and the update task flow (which uses maxTurns: 10).

