# Plan: 045

Captured: 2025-09-14T00:18:29.489Z

# Plan: Improve Pre-Compaction Hook for Task Progress Updates

## Overview
Replace the current error pattern extraction in the pre-compact hook with automatic task progress updates using the existing log parser and Claude SDK.

## Implementation Plan

### 1. Remove Error Pattern Extraction Code
- Delete the entire `ErrorPatternExtractor` class and related functions
- Remove `analyzeErrorPatterns` and `updateLearnedMistakes` functions
- Remove all references to learned_mistakes.md file

### 2. Add Active Task Check
- Import `getActiveTaskId` from `../lib/claude-md`
- Early exit if no active task (return success with "No active task" message)

### 3. Parse Recent Transcript Messages
- Import and use `ClaudeLogParser` from `../lib/log-parser`
- Parse last 50 messages in simplified string format:
  ```typescript
  const parser = new ClaudeLogParser(transcriptPath);
  const messages = await parser.parse({
    format: 'plaintext',
    limit: 50,
    simplifyResults: true,
    includeTools: false
  });
  ```

### 4. Update Task File via Claude SDK
- Call Claude SDK's `prompt` function with:
  - Model: Sonnet
  - Timeout: 2 minutes (120000ms)
  - Working directory: Current project folder
  - Allowed tools: Read, Grep, Edit
  - Prompt includes:
    - Current task file path
    - Recent transcript messages
    - Instructions to update task progress sections only
    - Explicit instruction NOT to change status field
    - Only edit the specific task file, no other files

### 5. Update Hook Configuration
- Ensure `pre_compact` hook is properly configured in track.config.json
- Keep existing timeout settings

### 6. Update Dependencies
- Add Claude SDK dependency with proper type interface
- Include log parser in dependencies
- Keep existing logger and config dependencies

### 7. Testing Approach
- Create mock tests for:
  - No active task (early exit)
  - Active task with successful update
  - Claude SDK timeout/failure (graceful handling)
  - Log parser errors (continue without failing)

## Key Changes Summary
- **Remove**: All error pattern extraction logic (~400 lines)
- **Add**: Task progress update logic (~100 lines)
- **Keep**: Basic hook structure, logging, configuration checking

## Files to Modify
1. `src/hooks/pre-compact.ts` - Complete rewrite
2. `src/hooks/pre-compact.test.ts` - Update tests for new functionality

## Expected Behavior
- When compaction triggers with an active task, the hook will:
  1. Parse the last 50 transcript messages
  2. Send them to Claude with instructions to update task progress
  3. Claude will edit the task file's "Recent Progress" or "Current Focus" sections
  4. Task status remains unchanged (only `/complete-task` can change it)
- When no active task, hook exits early without doing anything
- On any error, hook continues (doesn't block compaction)