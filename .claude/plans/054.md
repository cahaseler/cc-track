# Plan: 054

Captured: 2025-09-15T12:58:39.440Z

# Plan: Add Comprehensive Code Review Feature to cc-track

## Overview
Add an optional code review feature that runs after validation passes in the prepare-completion phase. When enabled, it will launch a Claude Code SDK agent to perform comprehensive code review and write analysis to `code-reviews/TASK_XXX_[DATE].md`.

## Implementation Steps

### 1. Add Configuration Option
- Add `code_review` section to track.config.json under `features`
- Include only `enabled` flag (default: false)
- Hard-code timeout to 10 minutes (600000ms) and max_turns to 30 in implementation

### 2. Create Code Review Function in ClaudeSDK
- Add `performCodeReview()` function to `src/lib/claude-sdk.ts`
- Parameters: taskId, taskTitle, taskRequirements, gitDiff, projectRoot
- Use Claude SDK with Sonnet model, 10-minute timeout, 30 turns max
- Grant Read, Grep, Glob permissions plus Write/Edit to code-reviews/ directory only
- Return structured review result with markdown content

### 3. Integrate into prepare-completion Command
- After validation passes, check if code_review is enabled in config
- **Check if a review file already exists for this task** (glob for `code-reviews/TASK_XXX_*.md`)
- If review exists, skip the code review and inform user that review already exists
- If no review exists:
  - Gather required data: task requirements from task file, git diff from merge base, task ID and title
  - Call performCodeReview() function
  - Ensure code-reviews/ directory exists
  - Write output to `code-reviews/TASK_XXX_[DATE].md`
  - Show summary to user with path to review file

### 4. Review File Format
The review file will include:
- Task summary (ID, title, branch)
- Requirements alignment check
- Security assessment  
- Code quality analysis
- Performance considerations
- Architectural concerns
- Improvement suggestions
- Overall verdict

### 5. Implementation Details
- Use existing ClaudeSDK patterns with query() function
- Configure with cwd: projectRoot for proper context
- Stream results to capture complete analysis
- Handle timeouts gracefully with partial results
- Use the same dependency injection pattern as other hooks/commands
- **One review per task** - presence of any `TASK_XXX_*.md` file skips review generation

### 6. Testing
- Add tests to prepare-completion.test.ts that mock the ClaudeSDK performCodeReview function
- Test both enabled and disabled code review scenarios
- **Test skipping review when file already exists**
- Test file creation and error handling
- Follow existing test patterns with mock creation functions

## Benefits
- Automated comprehensive code review before task completion
- Consistent review quality and format
- Documentation of code quality decisions
- Security and performance issue detection
- Learning from review patterns over time
- **Idempotent** - can run prepare-completion multiple times without duplicate reviews

## Non-Goals
- This won't block task completion (advisory only)
- Won't modify code automatically
- Won't replace human review for PRs