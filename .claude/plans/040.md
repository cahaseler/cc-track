# Plan: 040

Captured: 2025-09-12T21:03:02.246Z

## Plan: Create Claude Code JSONL Log Parser Utility

### Goal
Create a comprehensive utility function to parse Claude Code JSONL logs with filtering, simplification, and flexible output formats.

### Implementation Plan

#### 1. Create New Library Module: `src/lib/log-parser.ts`
- **LogEntry Interface**: Complete type definition for all JSONL fields
- **ParseOptions Interface**: Configuration for filtering and output
  - timeRange: { start?: Date, end?: Date }
  - role: 'user' | 'assistant' | 'system' | 'all'
  - limit?: number
  - format: 'json' | 'plaintext'
  - includeTools: boolean
  - simplifyResults: boolean
  
#### 2. Core Parser Class: `ClaudeLogParser`
- **Constructor**: Accept log file path or stream
- **parse() method**: Main entry point with options
- **Private methods**:
  - `loadEntries()`: Stream-based loading (handle large files)
  - `filterByTimeRange()`: Filter entries by timestamp
  - `filterByRole()`: Filter by message role
  - `simplifyEntry()`: Flatten complex structures
  - `formatOutput()`: Convert to JSON or plaintext

#### 3. Simplification Logic
- **User messages**: Extract text content, simplify to single string
- **Assistant messages**: 
  - Text responses → simplified text
  - Tool use → `[Tool: ${toolName}(${params})]`
  - Tool results → `[Result: success/failure - ${summary}]`
- **System messages**: Extract type and key info
- **Compact boundaries**: Mark session breaks clearly

#### 4. Output Formats
- **JSON format**: Array of simplified entries with metadata
- **Plaintext format**: Chat-like format with timestamps
  ```
  [2025-01-09 14:30:15] User: How do I run tests?
  [2025-01-09 14:30:18] Assistant: You can run tests with `bun test`
  [2025-01-09 14:30:20] Assistant: [Tool: Bash(bun test)]
  [2025-01-09 14:30:22] System: [Result: success - 42 tests passed]
  ```

#### 5. Create CLI Command: `src/commands/parse-logs.ts`
- Add to Commander CLI as `cc-track parse-logs`
- Options:
  - `--file <path>`: Input JSONL file (required)
  - `--from <date>`: Start date filter
  - `--to <date>`: End date filter  
  - `--role <role>`: Filter by role
  - `--limit <n>`: Max entries to return
  - `--format <format>`: json or plaintext (default: plaintext)
  - `--output <file>`: Output file (optional, default: stdout)
  - `--include-tools`: Include tool calls/results

#### 6. Add Tests: `src/lib/log-parser.test.ts`
- Test parsing various log entry types
- Test filtering by time range
- Test role filtering
- Test output formats
- Test error handling for malformed entries

#### 7. Integration Points
- Reuse in `stop-review.ts` to replace basic `getRecentMessages()`
- Potentially use in `pre-compact.ts` for better error extraction
- Future: Add to web UI or other visualization tools

### Benefits Over Existing Approach
- Handles all message types (not just user/assistant)
- Proper tool use/result parsing
- Time range filtering
- Configurable output formats
- Better error handling
- Reusable across hooks and commands
- Stream-based for large files
- Complete type safety

### Files to Create/Modify
1. **Create**: `src/lib/log-parser.ts` - Core parser implementation
2. **Create**: `src/lib/log-parser.test.ts` - Unit tests
3. **Create**: `src/commands/parse-logs.ts` - CLI command
4. **Modify**: `src/cli/index.ts` - Register new command
5. **Optional**: Update `stop-review.ts` to use new parser