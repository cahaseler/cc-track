# Plan: 033

Captured: 2025-09-12T12:06:06.586Z

## Plan: Split Task Completion into Two Phases (Revised)

### Overview
Create two complementary commands that separate the preparation/validation phase from the mechanical completion phase, leveraging existing stop-review hook for commits and enhancing PR automation.

### Phase 1: `/prepare-completion` Command
**Purpose:** Review, validate, fix issues, and prepare for task completion

#### Script Component (`src/commands/prepare-completion.ts`)
1. **Validation Checks:**
   - Run TypeScript check (`bunx tsc --noEmit`)
   - Run Biome linting (`bunx biome check`)
   - Run tests if configured (`bun test`)
   - Run Knip for unused code detection
   - Return structured JSON report with all issues

2. **Git Status:**
   - Check for uncommitted changes
   - List modified files
   - Count WIP commits
   - Identify if on task branch

3. **Task Verification:**
   - Verify active task exists
   - Check task status (should be in_progress)
   - Extract task ID and title

#### Claude Command (`.claude/commands/prepare-completion.md`)
**Claude's responsibilities based on script output:**
1. **Fix validation issues** (if any):
   - Fix TypeScript errors
   - Fix linting issues  
   - Fix failing tests
   - Address unused code warnings

2. **Journal reflection** (once, idempotent):
   - Technical insights from the task
   - Challenges and solutions
   - Patterns discovered
   - Only add new insights on subsequent runs

3. **Documentation updates** (if not already done):
   - Add "## Completion Summary" to task file
   - List what was delivered
   - Document key implementation details
   - Note any deviations from requirements

**Note:** Stop-review hook will automatically commit any documentation changes when Claude stops

**Exit criteria:** All validation passes, documentation complete

### Phase 2: `/complete-task` Command (Enhanced)
**Purpose:** Execute mechanical completion tasks after preparation passes

#### Script Component (Enhanced `src/commands/complete-task.ts`)
1. **Pre-flight Checks:**
   - Re-run validation (TypeScript, Biome, tests)
   - If ANY fail: Exit with message to run `/prepare-completion` first
   - Verify task is ready for completion

2. **Git Operations:**
   - Commit any remaining uncommitted changes (safety net)
   - Squash WIP commits into single feat commit

3. **GitHub PR Workflow:**
   - Check if PR already exists for current branch (prevent duplicates)
   - If no PR exists:
     - Push branch to origin
     - Create PR with basic title: `Task XXX: [Task Title]`
     - Return PR URL for enhancement
   - If PR exists:
     - Return existing PR URL

4. **Finalization:**
   - Update task status to completed
   - Update CLAUDE.md to no_active_task  
   - Switch to default branch automatically
   - Pull latest from origin
   - Return comprehensive completion report

#### Claude Command (Updated `.claude/commands/complete-task.md`)
**Claude's minimal responsibilities:**
1. **Validation Check:**
   - If validation failed: Tell user to run `/prepare-completion` first
   - Exit immediately if not ready

2. **PR Enhancement (if created):**
   - Use `gh pr edit [PR_URL] --body "[comprehensive description]"` to update PR description
   - Include what was delivered, technical details, testing notes

3. **Post-Merge Documentation:**
   - Wait for user to merge PR
   - Update progress_log.md with completion entry
   - Update decision_log.md if applicable
   - Update system_patterns.md if applicable
   - Remove from backlog if present

### Key Design Changes from Original Plan

#### Leverage Existing Automation
- **Stop-review hook** handles documentation commits automatically
- No manual commit step needed in prepare phase
- Safety commit in complete phase catches any stragglers

#### Smarter PR Handling
- Check for existing PR to prevent duplicates
- Create with simple title, enhance with gh pr edit
- Automatic branch switching and pull

#### Simplified Claude Flow
- Prepare: Fix issues, write documentation
- Complete: Enhance PR, wait for merge, update logs
- Clear handoff points between phases

### Implementation Steps

1. **Create `src/commands/prepare-completion.ts`:**
   - Extract validation logic from complete-task
   - Add test running capability
   - Return structured JSON with all issues

2. **Create `.claude/commands/prepare-completion.md`:**
   - Script execution with `!` prefix
   - Clear instructions for fixing issues
   - Idempotent documentation updates
   - Note about automatic commit via stop-review

3. **Update `src/commands/complete-task.ts`:**
   - Add pre-flight validation check
   - Add PR existence check using `gh pr list --head [branch]`
   - Add automatic branch switch and pull
   - Safety commit before squash
   - Return PR URL in result

4. **Update `.claude/commands/complete-task.md`:**
   - Simplify to validation check and PR enhancement
   - Add instructions for using gh pr edit
   - Move final documentation to post-merge section

5. **Update CLI to register new command:**
   - Add prepare-completion to commander setup

### Benefits

1. **Efficiency:** Leverages existing automation (stop-review hook)
2. **Safety:** Prevents duplicate PRs, handles edge cases
3. **Token savings:** Minimal Claude involvement in mechanical tasks
4. **Better UX:** Automatic branch management, clear workflow
5. **Idempotent:** Can safely re-run either phase

### Example Workflow

1. User: `/prepare-completion`
   - Claude fixes issues, updates documentation
   - Stop-review commits changes automatically

2. User: `/prepare-completion` (if needed again)
   - Claude fixes any remaining issues
   - Documentation updates are idempotent

3. User: `/complete-task`
   - Script validates, squashes, creates PR, switches branch
   - Claude enhances PR description
   - User merges PR

4. After merge:
   - Claude updates progress log and other documentation

### Testing Strategy

1. Test with validation errors → prepare → complete flow
2. Test PR duplicate prevention
3. Test automatic branch switching
4. Test idempotent documentation updates
5. Test with existing PR scenario