# Plan: 059

Captured: 2025-09-15T20:11:25.604Z

## Plan: Handle Second Runs of complete-task Command

### Problem
When `/complete-task` is run a second time on the same task (e.g., after making additional changes requested in PR review), it incorrectly attempts to squash commits again, which can cause issues since the commits may have already been squashed in the first run.

### Solution
Modify the complete-task command to detect if it's being run a second time (PR already exists) and adjust its behavior accordingly:

1. **Early PR Detection**: Move the PR existence check to happen BEFORE any git operations
2. **Conditional Squashing**: Only squash commits if no PR exists for the branch
3. **Smart Push**: Always push new commits (if any) regardless of PR status
4. **Branch Switching**: Always switch back to default branch after completion

### Implementation Steps

1. **Restructure complete-task.ts flow**:
   - Move PR existence check before the squashing section (currently at line 186)
   - Store PR existence state in a variable
   - Make squashing conditional based on PR existence

2. **Modify git operations logic**:
   - If PR exists: Skip squashing, just push any new commits
   - If no PR exists: Current behavior (squash, then create PR)

3. **Update user messaging**:
   - For second runs: Inform user that PR was updated (not created)
   - Show what was pushed without mentioning squashing

4. **Ensure push still happens**:
   - Extract push logic so it runs regardless of squashing
   - Handle the case where there might be nothing to push

This approach ensures that:
- First run: Squashes commits, creates PR, switches branches
- Second+ runs: Pushes new commits to existing PR, switches branches
- No duplicate PRs are created
- No unnecessary squashing that could lose commit history