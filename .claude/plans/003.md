# Plan: 003

Captured: 2025-09-10T00:35:37.174Z

## Git-Based Deviation Detection System

### Core Concept
Implement automatic git commits at every Stop hook to create clean checkpoints of actual changes, enabling easy deviation detection and recovery.

### Implementation Plan

1. **Create Stop Hook for Auto-commits** (`hooks/stop_autocommit.ts`)
   - Detect if in git repository (initialize if not)
   - Stage all changes
   - Commit with structured message including task ID
   - Include timestamp and change summary

2. **Add Deviation Detection** (`hooks/stop_review.ts`)
   - Read current active task requirements
   - Diff recent changes against last user interaction
   - Use Claude CLI to evaluate if changes align with task
   - Generate warning if deviation detected

3. **Create Pre-push Migration Guide**
   - Document how to move pre-commit hooks to pre-push
   - Provide script to automate the migration
   - Maintain quality gates while allowing dirty commits

4. **Add Git Utilities** (`scripts/git-utils.ts`)
   - `revert-to-last-user`: Reset to last commit before current work session
   - `squash-session`: Combine all commits since last user message
   - `review-changes`: Show diff with task alignment analysis

5. **Update Settings Template**
   - Add Stop hook configuration
   - Make it opt-in initially with clear documentation
   - Include examples for different validation levels

6. **Integrate with Task System**
   - Tag commits with active task ID
   - Link commits to progress_log.md entries
   - Auto-update task status based on completion detection

### Configuration Options
- Commit frequency: every Stop, or every N stops
- Validation level: none, basic diff, or full Claude review  
- Auto-revert on deviation: warning only vs automatic rollback
- Commit message format: minimal vs detailed

This system would create a safety net for AI coding sessions while maintaining development velocity.