# Plan: 078

Captured: 2025-09-18T12:31:16.385Z

## Fix Claude SDK Copying Branch Comments from Other Task Files

### The Problem
When creating new task files, the Claude SDK copies HTML comments (like `<!-- issue_branch: ... -->`) from existing task files, causing branch name mismatches and breaking the complete-task PR flow.

### Implementation Plan

**1. Add explicit warning to the prompt (generateResearchPrompt function)**
- Add a clear instruction after line 160 warning about HTML comments
- Text: "IMPORTANT: Do NOT copy any HTML comments (<!-- ... -->) from other task files. These are metadata added later and should not be included in your task file."

**2. Add post-processing to clean up any copied comments**
- After Claude creates the task file (line 305 in enrichPlanWithResearch)
- Read the file content
- Use regex to remove any prematurely added HTML comments:
  ```typescript
  // Clean up any HTML comments that shouldn't be there yet
  let content = fileOps.readFileSync(taskFilePath, 'utf-8');
  content = content.replace(/<!--\s*(github_issue|github_url|issue_branch|branch):.*?-->/g, '');
  fileOps.writeFileSync(taskFilePath, content.trim());
  ```

**3. Update the fallback path too**
- Apply the same cleaning after line 331 where the fallback creates a task file

This two-pronged approach ensures:
1. Claude is explicitly told not to copy these comments (prevention)
2. Any comments that slip through are removed (cleanup)
3. The correct metadata is added later by the normal flow

The fix is minimal, focused, and solves the root cause without breaking existing functionality.