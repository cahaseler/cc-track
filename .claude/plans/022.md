# Plan: 022

Captured: 2025-09-10T21:07:27.752Z

## Plan: Make stop_review Hook More Lenient About Documentation Updates

### Overview
Modify the stop_review hook to filter out .md file changes from the git diff before sending to Claude for review, while also updating the prompt to clarify that documentation updates are always acceptable. This will save tokens and prevent false deviation detections.

### Implementation Details

#### 1. Modify `getGitDiff()` Method
Create a new method `getFilteredGitDiff()` that:
- Gets the full git diff
- Filters out changes to .md files
- Returns only non-documentation changes for review
- Keep a separate flag indicating if there were documentation-only changes

#### 2. Update Review Logic
Enhance the review process to:
- Use filtered diff for deviation detection
- If filtered diff is empty but there were .md changes, skip review entirely (documentation-only changes are always OK)
- Include a note in the review prompt that .md file updates are excluded and always acceptable

#### 3. Improve Commit Message Generation
When changes are documentation-only:
- Generate appropriate commit messages like "docs: update progress log" or "docs: update learned mistakes"
- Don't send to Claude for review at all

### Specific Changes

#### In `stop_review.ts`:

1. **Add new method after `getGitDiff()`:**
```typescript
private getFilteredGitDiff(): { fullDiff: string; filteredDiff: string; hasDocChanges: boolean } {
  const fullDiff = this.getGitDiff();
  
  if (!fullDiff) {
    return { fullDiff: '', filteredDiff: '', hasDocChanges: false };
  }
  
  // Parse diff to filter out .md files
  const lines = fullDiff.split('\n');
  const filteredLines: string[] = [];
  let currentFile = '';
  let skipCurrentFile = false;
  let hasDocChanges = false;
  
  for (const line of lines) {
    // Detect file headers in diff
    if (line.startsWith('diff --git')) {
      const fileMatch = line.match(/b\/(.+)$/);
      currentFile = fileMatch ? fileMatch[1] : '';
      skipCurrentFile = currentFile.endsWith('.md');
      if (skipCurrentFile) {
        hasDocChanges = true;
        continue;
      }
    }
    
    if (!skipCurrentFile) {
      filteredLines.push(line);
    }
  }
  
  return {
    fullDiff,
    filteredDiff: filteredLines.join('\n'),
    hasDocChanges
  };
}
```

2. **Update `review()` method:**
- Replace `getGitDiff()` calls with `getFilteredGitDiff()`
- Handle documentation-only changes specially:
```typescript
const { fullDiff, filteredDiff, hasDocChanges } = this.getFilteredGitDiff();

// If only documentation changes, auto-approve
if (hasDocChanges && !filteredDiff.trim()) {
  return {
    status: 'on_track',
    message: 'Documentation updates only',
    commitMessage: '[wip] docs: update project documentation',
  };
}

// Use filteredDiff for review, but fullDiff for commit message generation
```

3. **Update `buildReviewPrompt()` to clarify:**
Add to the prompt:
```
## Important Notes:
- Changes to .md (markdown/documentation) files have been filtered out and are always acceptable
- Focus only on code changes shown in the diff below
```

4. **Update commit message generation:**
When using `generateCommitMessage()`, check if changes are documentation-only and generate appropriate messages without calling Claude.

### Benefits

1. **Token Savings:** Markdown files can be large (especially progress_log.md, learned_mistakes.md). Filtering them saves significant tokens.

2. **Fewer False Positives:** Documentation updates won't trigger deviation warnings.

3. **Clearer Intent:** The prompt explicitly states that documentation is excluded, preventing confusion.

4. **Better Performance:** Less data to send to Claude means faster reviews.

5. **Appropriate Commit Messages:** Documentation-only changes get proper "docs:" prefixed messages.

### Testing Strategy

1. Test with code-only changes (should review normally)
2. Test with documentation-only changes (should auto-approve)
3. Test with mixed changes (should review code parts only)
4. Test with learned_mistakes.md updates specifically
5. Verify commit messages are appropriate for each case

### Files to Modify

1. **Update:** `.claude/hooks/stop_review.ts`
   - Add `getFilteredGitDiff()` method
   - Update `review()` method to use filtered diff
   - Update `buildReviewPrompt()` with clarification
   - Handle documentation-only commits specially

2. **Update:** `.claude/backlog.md`
   - Remove the addressed item about deviation detection

This approach efficiently addresses the issue by preventing documentation changes from affecting the deviation detection while saving tokens and improving performance.