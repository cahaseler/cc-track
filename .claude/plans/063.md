# Plan: 063

Captured: 2025-09-16T14:55:47.701Z

## Plan: Add Configurable Code Review Tool Support

### Objective
Make the code review tool configurable in cc-track, initially supporting "claude" (current implementation) and "coderabbit" as options.

### Implementation Steps

#### 1. Update Configuration Structure
- Modify `src/lib/config.ts`:
  - Change `code_review` from a simple boolean/HookConfig to support a `tool` property
  - Add new interface `CodeReviewConfig` extending `HookConfig` with:
    - `tool: 'claude' | 'coderabbit'` (default: 'claude')
  - Update `isCodeReviewEnabled()` to handle the new structure
  - Add `getCodeReviewTool()` function to get the selected tool

#### 2. Create CodeRabbit Review Implementation
- Add new file `src/lib/code-review/coderabbit.ts`:
  - Implement `performCodeRabbitReview()` function that:
    - Runs `coderabbit --plain --base <merge-base>` 
    - Hardcoded 15-minute timeout (900000ms)
    - Captures the output
    - Parses the structured output format (file/line/type/comment/prompt sections)
    - Formats it into a markdown review file
    - Saves to `code-reviews/` directory with timestamp
  - Handle CodeRabbit not being installed (check with `which coderabbit`)

#### 3. Create Claude Review Implementation  
- Move existing Claude review logic to `src/lib/code-review/claude.ts`:
  - Extract `performClaudeReview()` from current `ClaudeSDK.performCodeReview()`
  - Keep the same implementation but in isolated module
  - Maintain existing 10-minute timeout for Claude (600000ms)

#### 4. Create Review Abstraction Layer
- Add `src/lib/code-review/index.ts`:
  - Export a `performCodeReview()` function that:
    - Checks the configured tool via `getCodeReviewTool()`
    - Delegates to appropriate implementation
    - Returns standardized result format
  - Define common `CodeReviewResult` interface

#### 5. Update Prepare Completion Command
- Modify `src/commands/prepare-completion.ts`:
  - Import the new abstracted `performCodeReview()` 
  - Replace direct `ClaudeSDK.performCodeReview()` call
  - Display which tool is being used in output messages

#### 6. Update Init Command
- Modify `src/commands/init.ts`:
  - Update the code review configuration prompt to ask for tool choice
  - Default to 'claude' for backward compatibility
  - Explain differences: Claude (comprehensive agent-based, ~10min) vs CodeRabbit (fast focused analysis, ~2-5min)

#### 7. Add Tests
- Create tests for:
  - Configuration parsing with new structure
  - CodeRabbit output parsing
  - Tool selection logic
  - Error handling for each tool

#### 8. Update Documentation
- Update embedded templates to show new config format
- Document in decision_log.md why we're adding this flexibility
- Update system_patterns.md with the new abstraction pattern

### Key Design Decisions

1. **Backward Compatibility**: Existing configs with `code_review: true` will default to Claude
2. **Tool Abstraction**: Common interface allows easy addition of more tools later
3. **Output Format**: Both tools write to the same `code-reviews/` directory in markdown
4. **Error Handling**: Tool failures won't block task completion (warning only)
5. **Fixed Timeouts**: 15 minutes for CodeRabbit, 10 minutes for Claude (no config needed)

### Files to Modify
- `src/lib/config.ts` - Configuration structure
- `src/commands/prepare-completion.ts` - Use abstracted review
- `src/commands/init.ts` - Setup prompts
- `src/lib/claude-sdk.ts` - Extract review logic

### Files to Create  
- `src/lib/code-review/index.ts` - Abstraction layer
- `src/lib/code-review/claude.ts` - Claude implementation  
- `src/lib/code-review/coderabbit.ts` - CodeRabbit implementation
- `src/lib/code-review/types.ts` - Shared types

### Testing Approach
- Test CodeRabbit integration manually first with different scenarios
- Mock the execSync calls in tests to simulate CodeRabbit output
- Ensure both tools produce compatible markdown format in code-reviews/