# Plan: 060

Captured: 2025-09-15T22:01:48.113Z

# Fix Capture-Plan Hook to Commit Task Files Without CLAUDE.md Updates

## Problem
The capture-plan hook creates task files on main branch AND updates CLAUDE.md on main, causing merge conflicts and violating branch protection principles.

## Corrected Root Cause Analysis
1. **capture-plan hook runs on main branch** and creates `.claude/tasks/TASK_XXX.md` and `.claude/plans/XXX.md`
2. **INCORRECTLY updates CLAUDE.md on main** to point to new task (should only happen on branch)
3. **Files are left uncommitted** on main branch
4. **Then branches are created** and CLAUDE.md gets updated again on the branch
5. **When PR merges**, conflict occurs because CLAUDE.md was modified in both places

## Corrected Solution
1. **Commit+push only the task files** to main (NOT CLAUDE.md)
2. **Move CLAUDE.md update to happen AFTER branch creation** (on the feature branch)

## Implementation Plan

### 1. Add Commit+Push Function (Task Files Only)
```typescript
function commitTaskFilesToMain(
  taskId: string, 
  projectRoot: string, 
  deps: CapturePlanDependencies
): void {
  const exec = deps.execSync || execSync;
  const logger = deps.logger || createLogger('capture_plan');
  
  try {
    // Add ONLY the task files, NOT CLAUDE.md
    exec(`git add .claude/tasks/TASK_${taskId}.md .claude/plans/${taskId}.md`, { cwd: projectRoot });
    
    // Commit with conventional format
    exec(`git commit -m "docs: create TASK_${taskId} files"`, { cwd: projectRoot });
    
    // Push to main immediately
    exec('git push origin main', { cwd: projectRoot });
    
    logger.info(`Committed and pushed task files for ${taskId} to main`);
  } catch (error) {
    logger.warn(`Failed to commit task files: ${error}`);
  }
}
```

### 2. Restructure Hook Flow
**Current problematic flow:**
1. Create task files on main
2. Update CLAUDE.md on main ❌
3. Create branch
4. Switch to branch

**New correct flow:**
1. Create task files on main
2. Commit+push task files to main ✅
3. Create branch and switch to it
4. Update CLAUDE.md on branch (not main) ✅

### 3. Specific Code Changes
1. **Remove** `updateClaudeMd()` call from main branch execution (line 609)
2. **Add** `commitTaskFilesToMain()` call after task files are written
3. **Move** `updateClaudeMd()` call to happen AFTER branching (on the feature branch)

### 4. Benefits
- **Main branch stays minimal**: Only contains committed task files, not active task pointer
- **CLAUDE.md only updated on branch**: Where the work actually happens
- **No merge conflicts**: Main's CLAUDE.md never points to specific tasks
- **Clean PR merges**: Task files already exist, CLAUDE.md changes are branch-specific

### 5. Result
- **Main branch**: Contains all task files but CLAUDE.md always points to `no_active_task.md`
- **Feature branches**: CLAUDE.md points to the specific task being worked on
- **No conflicts**: Clean separation between task registry (main) and active work (branches)