# Plan: 049

Captured: 2025-09-14T23:48:00.705Z

## Fix Complete-Task Squashing to Handle All Branch Commits

### Current Problem
The `complete-task` command only squashes commits if ALL commits are WIP-labeled (`wip:` or `[wip]`). When stop-review creates conventional commits (feat:, fix:, docs:), the squashing fails with "Found X WIP commits mixed with regular commits - manual review needed".

### Solution Approach
Replace the WIP-only squashing logic with branch-based squashing that:
1. Detects if we're on a feature/bug branch (not main/master)
2. Finds the merge-base (common ancestor) with the default branch
3. Squashes ALL commits from merge-base to HEAD into a single commit

### Implementation Plan

#### 1. Update Git Helpers (`src/lib/git-helpers.ts`)
Add a new method to find the merge-base:
```typescript
getMergeBase(branch1: string, branch2: string, cwd: string): string {
  try {
    return this.exec(`git merge-base ${branch1} ${branch2}`, { cwd }).trim();
  } catch {
    return '';
  }
}
```

#### 2. Refactor Squashing Logic in `src/commands/complete-task.ts`
Replace lines 204-251 with:
- Check if we're on a feature/bug branch (or any non-default branch)
- Get the default branch name (main/master)
- Find merge-base between current branch and default branch
- Count commits since merge-base
- If there are multiple commits, squash them all:
  ```bash
  git reset --soft <merge-base>
  git commit -m "<commit message>"
  ```

#### 3. Update Result Messages
Change messages from "No WIP commits found" to more accurate descriptions:
- "No commits to squash (already on default branch)"
- "Squashed X commits from branch into single commit"
- "Only one commit on branch - no squashing needed"

#### 4. Test the Changes
- Test with mixed commit types (wip:, feat:, fix:, docs:)
- Test on feature branches
- Test when already on main
- Test with single commit branches

### Benefits
- Works with any commit type, not just WIP
- More robust for real-world usage where stop-review creates conventional commits
- Cleaner PR history with single commit per task
- No manual intervention needed for squashing