# Plan: 008

Captured: 2025-09-10T11:38:16.292Z

## Plan: Add Git Branch Support to cc-pars

### Overview
Add optional git branch support that creates feature branches for each task and merges them back on completion. This feature will be configurable via the cc-pars config.

### Key Components

#### 1. Configuration Update
Add new feature to `.claude/cc-pars.config.json`:
```json
"features": {
  "git_branching": {
    "enabled": false,
    "description": "Create feature branches for tasks and merge on completion"
  }
}
```

#### 2. Update capture_plan.ts Hook
When git_branching is enabled and a new task is created:
1. Check for uncommitted changes
2. If changes exist:
   - Generate commit message using Claude CLI Haiku
   - Commit with generated message
3. Generate branch name using Claude CLI Haiku (format: feature/description or bug/description)
4. Create and switch to new branch

#### 3. Update complete-task Command
When git_branching is enabled and task is completed:
1. Squash commits as usual
2. Switch back to default branch (main/master)
3. Merge the task branch
4. **Keep the task branch for reference** (no deletion)
5. Stay on default branch

#### 4. Create Git Helper Module
New file: `.claude/lib/git-helpers.ts`
- `getDefaultBranch()`: Get main/master branch name
- `hasUncommittedChanges()`: Check for uncommitted work
- `generateCommitMessage(diff)`: Use Claude CLI Haiku to generate message
- `generateBranchName(taskPlan)`: Use Claude CLI Haiku to generate branch name
- `createTaskBranch(branchName)`: Create and switch to branch
- `mergeTaskBranch(branchName)`: Merge branch back to default

### Implementation Details

#### Commit Message Generation Prompt (Haiku)
```
CRITICAL: Return ONLY a git commit message, nothing else. No explanation, no markdown, just the message.
Based on these changes, write a concise commit message (max 50 chars first line):
[diff]
Format: type: description
Types: feat, fix, docs, style, refactor, test, chore
```

#### Branch Name Generation Prompt (Haiku)
```
CRITICAL: Return ONLY a branch name, nothing else. No explanation, no markdown, just the name.
Based on this plan, generate a git branch name:
[plan summary]
Format: feature/short-description OR bug/short-description
Use lowercase, hyphens, max 4 words after type
Examples: feature/add-auth, bug/fix-login, feature/user-dashboard
```

#### capture_plan.ts Changes
```typescript
import { isHookEnabled } from '../lib/config';
import { hasUncommittedChanges, generateCommitMessage, generateBranchName, createTaskBranch } from '../lib/git-helpers';

// After task file is created...
if (isHookEnabled('git_branching')) {
  // Commit any uncommitted work
  if (hasUncommittedChanges(projectRoot)) {
    const diff = execSync('git diff HEAD', { encoding: 'utf-8', cwd: projectRoot });
    const commitMsg = await generateCommitMessage(diff);
    execSync(`git add -A && git commit -m "${commitMsg}"`, { cwd: projectRoot });
  }
  
  // Create and switch to task branch
  const branchName = await generateBranchName(plan);
  createTaskBranch(branchName, projectRoot);
  
  // Store branch name in task file for later reference
  taskContent += `\n\n<!-- branch: ${branchName} -->`;
}
```

#### complete-task.md Changes
Add new step after squashing commits:
```markdown
9.5. **Merge Task Branch** (if git_branching enabled):
   - Extract branch name from task file
   - Switch to default branch
   - Merge task branch
   - Note: Branch is kept for reference (not deleted)
   - List of task branches can be viewed with: git branch | grep -E "feature/|bug/"
```

### File Changes Summary
1. **Update**: `.claude/cc-pars.config.json` - Add git_branching feature
2. **Create**: `.claude/lib/git-helpers.ts` - Git utility functions
3. **Update**: `.claude/hooks/capture_plan.ts` - Add branch creation logic
4. **Update**: `.claude/commands/complete-task.md` - Add branch merge instructions
5. **Update**: `.claude/lib/config.ts` - Add git_branching to DEFAULT_CONFIG
6. **Update**: `.claude/commands/config-cc-pars.md` - Document new feature

### Benefits
- Clean separation of work per task
- Easy rollback if task goes wrong
- Clear git history with branches per feature
- **Branches preserved as backup/reference**
- Optional - doesn't affect existing workflow if disabled
- Automatic handling of uncommitted changes

### Considerations
- Default to disabled to not surprise users
- Branch names are auto-generated but stored for reference
- Uses Haiku for cost efficiency (simple text generation)
- No push/PR operations (local only for now)
- Task branches accumulate over time (user can manually clean up old ones)