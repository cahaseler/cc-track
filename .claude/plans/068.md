# Plan: 068

Captured: 2025-09-17T11:11:36.422Z

## Fix index.test.ts Using Proper Dependency Injection

### The Problem
Our previous "fix" kept using `mock.module` with dynamic imports, which doesn't work in CI. The tests are still failing with the exact same errors - getting "CodeRabbit review content" from the wrong mock.

### The Proper Solution
Refactor to use dependency injection like the rest of the codebase:

1. **Modify `performCodeReview` in index.ts** to accept optional dependencies:
   ```typescript
   export async function performCodeReview(
     options: CodeReviewOptions,
     deps: {
       isCodeReviewEnabled?: typeof isCodeReviewEnabled,
       getCodeReviewTool?: typeof getCodeReviewTool,
       performClaudeReview?: typeof performClaudeReview,
       performCodeRabbitReview?: typeof performCodeRabbitReview,
       logger?: ReturnType<typeof createLogger>
     } = {}
   ): Promise<CodeReviewResult>
   ```

2. **Remove ALL `mock.module` usage from index.test.ts**

3. **Pass mocked functions directly as dependencies** in each test:
   ```typescript
   const result = await performCodeReview(options, {
     isCodeReviewEnabled: mock(() => false),
     getCodeReviewTool: mock(() => 'claude')
   });
   ```

This follows the exact pattern used successfully throughout the codebase and documented in `src/CLAUDE.md`. No more `mock.module`, no more pollution, no more lies about what approach we're using.