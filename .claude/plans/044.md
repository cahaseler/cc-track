# Plan: 044

Captured: 2025-09-13T22:57:19.285Z

## Task File Edit Validation Enhancement Plan

### Overview
Create a new PreToolUse hook that validates edits to task files using Claude SDK to prevent:
1. Setting task status to "complete" (should only be done via `/complete-task` command)
2. Using weasel words to claim completion without finishing the work

### Implementation Steps

#### 1. Create New Task Validation Hook (`src/hooks/task-validation.ts`)
- New file for PreToolUse validation of Edit/MultiEdit operations on task files
- Will use Claude SDK's `prompt` function with Sonnet model
- Check if file path matches `.claude/tasks/TASK_*.md` pattern
- Extract old/new content from tool_input for validation
- Pass diff to Claude for review with strict validation instructions

#### 2. Update Hook Dispatcher (`src/commands/hook.ts`)
- Add PreToolUse case to `determineHookType` function
- Import and register the new `task-validation` hook
- Route Edit/MultiEdit PreToolUse events to task validation

#### 3. Configure PreToolUse in Settings (`/.claude/settings.json`)
- Add PreToolUse configuration for Edit and MultiEdit matchers
- Point to the cc-track hook command with appropriate timeout

#### 4. Add Configuration Support (`/.claude/track.config.json`)
- Add `task_validation` section under hooks
- Include enabled flag and configuration options

#### 5. Update Types if Needed
- Extend HookOutput interface if PreToolUse requires specific fields
- Based on docs, PreToolUse uses `hookSpecificOutput.permissionDecision` and `hookSpecificOutput.permissionDecisionReason`

### Key Technical Details

**PreToolUse Output Format (from docs):**
```json
{
  "hookSpecificOutput": {
    "hookEventName": "PreToolUse",
    "permissionDecision": "deny",
    "permissionDecisionReason": "Detailed explanation of why edit was blocked"
  }
}
```

**Validation Prompt Structure:**
- Pass the full diff (old_string vs new_string)
- Include task file path for context
- Instruct Claude to check for:
  - Status field changes to "completed"
  - Weasel words about test/lint failures
  - Claims of environmental issues instead of fixing problems
- Emphasize 100% pass rate requirement for all tests/lints/typechecks

**Integration Points:**
- Use dependency injection pattern consistent with other hooks
- Accept ClaudeSDK as optional dependency for testing
- Log validation decisions for debugging
- Handle timeouts and errors gracefully (allow edit on error)

### Testing Considerations
- Mock ClaudeSDK responses in tests
- Test with various edit patterns (status changes, weasel words)
- Ensure non-task files pass through without validation
- Test error handling and timeout scenarios

This implementation will create a safety net preventing premature task completion claims while maintaining the existing PostToolUse validation for TypeScript/Biome checks.