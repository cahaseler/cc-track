# Plan: 011

Captured: 2025-09-10T13:33:37.189Z

## Centralized Logging System for cc-pars

### Goal
Create a centralized, structured logging system for all cc-pars hooks, commands, and utilities to improve debugging, monitoring, and issue diagnosis.

### Design Decisions

#### 1. Logging Library Choice
**Decision**: Use built-in approach with minimal dependencies
- **Rationale**: While adze is excellent, cc-pars should remain lightweight and dependency-free where possible
- **Alternative considered**: Adze would provide great features but adds a dependency
- **Approach**: Create a simple but effective logger module that can be enhanced later

#### 2. Architecture
- **Central logger module**: `.claude/lib/logger.ts`
- **Log directory**: `.claude/logs/`
- **Log rotation**: Daily files with automatic cleanup of old logs (>7 days)
- **Log levels**: ERROR, WARN, INFO, DEBUG, TRACE
- **Structured format**: JSON lines for machine parsing, with pretty-print option

### Implementation Plan

#### Phase 1: Core Logger Module
1. **Create `.claude/lib/logger.ts`**:
   - Logger class with level-based methods
   - Automatic file rotation (daily)
   - Structured JSON output
   - Context injection (hook name, session ID, etc.)
   - Configurable via cc-pars.config.json

2. **Features**:
   ```typescript
   interface LogEntry {
     timestamp: string;
     level: LogLevel;
     source: string;  // hook/command/script name
     message: string;
     context?: Record<string, any>;
     error?: string;
     stack?: string;
   }
   ```

3. **Configuration in `cc-pars.config.json`**:
   ```json
   {
     "logging": {
       "enabled": true,
       "level": "INFO",
       "retentionDays": 7,
       "prettyPrint": false
     }
   }
   ```

#### Phase 2: Integration
1. **Update all hooks** to use centralized logger:
   - `capture_plan.ts`: Replace console.error with logger
   - `stop_review.ts`: Replace appendFileSync with logger
   - `pre_compact.ts`: Add logging for extraction process
   - `post_compact.ts`: Add logging for restoration

2. **Update utilities**:
   - `git-helpers.ts`: Log git operations
   - `config.ts`: Log config changes
   - Scripts in `/scripts/`: Add operation logging

3. **Remove old logging**:
   - Delete `/tmp/stop_review_debug.log` references
   - Remove direct console.log/error calls
   - Clean up one-off debug files

#### Phase 3: Log Viewer Command
1. **Create `/commands/view-logs.md`**:
   - Show recent logs
   - Filter by level, source, or time
   - Search for patterns
   - Export specific ranges

2. **Example usage**:
   ```
   /view-logs --level ERROR --hours 24
   /view-logs --source capture_plan --grep "Plan was not approved"
   /view-logs --tail 50
   ```

#### Phase 4: Hook Debugging Enhancement
1. **Add debug mode for specific hooks**:
   - Environment variable or config flag
   - Verbose logging when enabled
   - Input/output capture

2. **Specific improvements for capture_plan debugging**:
   - Log full input data structure
   - Log tool_response details
   - Log Claude CLI command and response
   - Track task creation success/failure

### File Structure
```
.claude/
├── logs/
│   ├── 2025-09-10.jsonl     # Daily log files
│   ├── 2025-09-11.jsonl
│   └── .gitignore            # Ignore log files
├── lib/
│   ├── logger.ts             # Central logger module
│   └── log-viewer.ts         # Log viewing utilities
└── commands/
    └── view-logs.md          # Log viewer command
```

### Testing Strategy
1. Create test script that triggers various log levels
2. Verify file rotation works correctly
3. Test log cleanup for old files
4. Ensure no performance impact on hooks
5. Verify JSON format is valid and parseable

### Migration Plan
1. Implement logger module first
2. Update one hook (capture_plan) as proof of concept
3. Verify it captures the plan approval issue
4. Roll out to remaining hooks and scripts
5. Add log viewer command last

### Benefits
- **Debugging**: Finally see what's happening in capture_plan hook
- **Monitoring**: Track patterns and issues over time
- **Performance**: Identify slow operations
- **Audit trail**: Record of all cc-pars operations
- **Troubleshooting**: Users can share logs for support

### Non-Goals
- Remote log shipping
- Log aggregation across projects
- Real-time log streaming
- Complex analytics

This approach gives us powerful debugging capabilities while keeping cc-pars lightweight and dependency-free.