# Plan: 067

Captured: 2025-09-17T01:37:10.549Z

## Fix GitHub Release Pipeline - mock.module Cross-Test Pollution

### Root Cause Identified
The CI tests are failing due to `mock.module` pollution between test files. Specifically:

1. `index.test.ts` uses `mock.module('./coderabbit', ...)` to mock the entire coderabbit module
2. This mock returns `{ success: true, review: 'CodeRabbit review content' }`
3. In CI, this mock persists and affects `coderabbit.test.ts` tests
4. The coderabbit tests expect their own mocks to work but get the index.test.ts mock instead

### Evidence:
- CI errors show "CodeRabbit review content" - a string only found in index.test.ts
- Tests run at 1ms in CI (mocked speed) but return wrong values
- Tests pass locally but fail in CI (different test execution order/parallelization)
- The mock.module calls in index.test.ts aren't properly isolated

### Solution:
Fix the mock isolation in `index.test.ts` by:

1. **Add proper cleanup in afterEach**:
   - Call `mock.restore()` after each test
   - Ensure mock.module effects don't persist

2. **Or switch to dependency injection pattern**:
   - Instead of mock.module, pass mocked dependencies directly
   - This matches the pattern used in coderabbit.test.ts

3. **Verify fix**:
   - Run tests in different orders to ensure no pollution
   - Test passes in CI environment

This will fix the release pipeline by preventing test interference.