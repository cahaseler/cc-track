# Plan: 029

Captured: 2025-09-12T00:27:55.518Z

## Plan to Consolidate Duplicate Helper Functions

### 1. Create src/lib/claude-md.ts (High Priority)
- Extract common CLAUDE.md operations into a single module
- Functions to implement:
  - `getActiveTaskFile(projectRoot): string | null` - Returns task filename
  - `getActiveTaskId(projectRoot): string | null` - Returns TASK_XXX id
  - `getActiveTaskContent(projectRoot): string | null` - Returns full task content
  - `setActiveTask(projectRoot, taskId): void` - Updates CLAUDE.md to point to task
  - `clearActiveTask(projectRoot): void` - Sets to no_active_task.md
- Update all consumers: statusline, stop-review, post-compact, capture-plan, complete-task

### 2. Consolidate Git Helpers (High Priority)
- Remove duplicate `hasUncommittedChanges` from stop-review.ts
- Remove duplicate `getCurrentBranch` from statusline.ts
- Replace inline default branch detection in complete-task.ts with `getDefaultBranch`
- Move `isWipCommit` to git-helpers.ts and export it
- Update all imports to use the centralized functions

### 3. Fix Config Access in complete-task.ts (Medium Priority)
- Replace direct JSON.parse calls with config library functions
- Use `getConfig()` for general config access
- Use `isGitHubIntegrationEnabled()` for GitHub checks
- Leverage existing validation config structure from edit-validation hook

### 4. Extract Validation Utilities (Low Priority - Optional)
- Create src/lib/validation.ts with shared validation logic
- Move TypeScript/Biome/Knip runners from edit-validation
- Reuse in complete-task for project-wide checks
- This is optional since the use cases differ (file vs project scope)

### 5. Testing Strategy
- Run existing test suites after each module change
- Verify no behavior changes with integration testing
- Use git diff to ensure only imports changed in consumer files

### Implementation Order
1. Git helpers first (simplest, most duplicated)
2. CLAUDE.md operations (most complex, highest impact)
3. Config access (straightforward replacement)
4. Validation utilities (optional, can be deferred)

This will eliminate ~150 lines of duplicate code and prevent future drift between implementations.