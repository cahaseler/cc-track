# Plan: 030

Captured: 2025-09-12T03:06:51.565Z

## Fix Post-Compaction Token Duplication

### Problem
The post-compact hook is duplicating context files, consuming ~25k unnecessary tokens per compaction:
- Context files are imported via `@` references in CLAUDE.md (counted as "memory")  
- The same files are read and included in full in the session-start message (counted as "messages")

### Solution
Modify the post-compact hook to only reference the imported files without including their content:

1. **Update `readImportedFiles` function** (lines 27-59):
   - Instead of reading file content, just collect the filenames
   - Return only the list of imported files, not their content

2. **Update `generatePostCompactionInstructions` function** (lines 89-142):
   - Remove the "## Imported Context Files:" section with full content
   - Add a brief note listing which files are imported via CLAUDE.md
   - Keep all the instructions about reviewing journal, updating docs, etc.

3. **Update tests** to match the new behavior:
   - Tests should verify files are listed but not included
   - Adjust expectations for the generated instructions

4. **Rebuild the CLI** after making changes

### Expected Outcome
- Save ~12.7k tokens per compaction cycle
- Keep the same functionality (files still accessible via @ imports)
- Maintain all post-compaction instructions and documentation updates

### Additional Monitoring
While making these changes, I'll watch for any system notifications about file edits to determine if VSCode is also contributing to token consumption.