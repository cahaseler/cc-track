# Plan: 055

Captured: 2025-09-15T14:45:55.816Z

## Enhance Task Creation with Comprehensive Research Capabilities

### Current State
The capture-plan hook currently:
- Takes the raw plan from ExitPlanMode
- Uses a single Claude SDK prompt to reformat it into a task file structure
- Provides a basic template with sections like Requirements, Success Criteria, Technical Approach

### Problem
Task files often have gaps like:
- "Open Questions & Blockers" with vague unknowns
- Technical approaches that miss existing patterns in the codebase
- Requirements that could be more specific if current code was examined

### Solution: Multi-Turn Research Agent

I'll enhance the task creation to use a multi-turn Claude SDK agent that can:
1. **Identify knowledge gaps** in the plan
2. **Research the codebase** to find answers
3. **Discover existing patterns** to follow
4. **Generate comprehensive task files** with all context needed

### Implementation Plan

1. **Create new function: `enrichPlanWithResearch()`**
   - Replace simple prompt with multi-turn agent approach
   - Allow up to 20 turns for comprehensive research
   - Set 10-minute timeout for thorough investigation
   - Enable Read, Grep, Glob tools for codebase exploration

2. **Update the enrichment prompt** to:
   - Explicitly instruct Claude to identify gaps and unknowns
   - Research each gap using available tools
   - Find existing patterns and conventions in the codebase
   - Fill in concrete details based on actual code examination
   - Generate a self-contained task file

3. **Return full task content to Claude**
   - After task creation, add a systemMessage that includes the full task file content
   - This ensures Claude sees the enriched task immediately

4. **Update configuration** (if needed):
   - Add config option for research depth (turns/timeout)
   - Default to comprehensive research mode

5. **Testing considerations**:
   - Mock the multi-turn SDK calls appropriately
   - Test timeout handling
   - Verify research agent can read files

### Key Changes in `capture-plan.ts`:
- Replace `enrichPlanWithClaude()` with `enrichPlanWithResearch()` 
- Use `query()` directly instead of `prompt()` for multi-turn capability
- Configure with: maxTurns: 20, timeoutMs: 600000 (10 min)
- Allow tools: ['Read', 'Grep', 'Glob']
- Return systemMessage with full task content for Claude to see

### Expected Outcome
Task files will be comprehensive research documents that:
- Have concrete answers instead of vague questions
- Reference specific files and patterns in the codebase
- Include exact syntax and conventions to follow
- Serve as complete implementation guides