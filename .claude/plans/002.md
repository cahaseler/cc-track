# Plan: 002

Captured: 2025-09-09T21:23:28.120Z

# Summary of pre_compact.ts Hook Requirements

## What the pre_compact hook should do

The `pre_compact.ts` hook is triggered **before Claude Code begins context compaction** and serves as the critical context preservation system. Its primary purpose is to extract and preserve essential project knowledge that would otherwise be lost during compaction.

## Key Context to Preserve (4 Categories)

### 1. Environment & Configuration
- Database type and connection strings
- API endpoints and authentication methods
- Environment variables and configuration files
- Package.json dependencies and versions
- Node version, package manager, framework details

### 2. Codebase Structure
- Directory tree and file organization
- Key files and their purposes
- Import relationships and dependencies
- Function/class definitions and locations
- Code patterns and conventions being used

### 3. Current State
- Git branch and working directory status
- Recent commands and their outputs
- Test results and coverage information
- Error messages and their resolutions
- Task progress and completion status

### 4. Patterns & Decisions  
- Coding conventions and style guidelines
- Architecture patterns being followed
- Tool preferences (MCP vs CLI tools)
- User preferences extracted from conversation
- Recent technical decisions and their rationale

## How it should extract and update context

### Input Processing
- Read JSON from stdin containing: `session_id`, `transcript_path`, `cwd`, `hook_event_name`
- Parse the transcript file (JSONL format) to extract conversation history
- Analyze tool uses, file operations, commands executed, and error patterns

### Extraction Strategy
1. **Parse transcript for key events**:
   - File reads/writes and their content
   - Command executions and outputs  
   - Error messages and solutions
   - Tool usage patterns
   - User feedback and preferences

2. **Build structured knowledge**:
   - Extract function/class definitions from file operations
   - Map import relationships and dependencies
   - Capture configuration details and environment setup
   - Document patterns and conventions observed

3. **Update persistent context files**:
   - `code_index.md` - Codebase structure and key components
   - `system_patterns.md` - Technical patterns and standards
   - `decision_log.md` - Append new architectural decisions
   - `progress_log.md` - Document recent work and status

### Storage Format
Updates should use the existing markdown templates and append new information chronologically to preserve history.

## Specific Requirements & Patterns

### Technical Implementation
- **Runtime**: Bun with TypeScript
- **Timeout**: 30 seconds (as configured in settings.json)
- **Error handling**: Graceful failures - don't block compaction on errors
- **Output**: JSON response with success status and optional system message

### Integration Patterns
- **File imports**: Updated files are automatically included via CLAUDE.md @import syntax
- **Three-tier context**: Updates persistent (always imported), cached (periodically refreshed), and dynamic (gathered as needed) context
- **Hook communication**: Uses JSON stdin/stdout for data exchange
- **Safety first**: Never overwrite existing content, always append or create backups

### Success Criteria
- Context survival rate after compaction increases significantly
- Key technical details (DB setup, API endpoints, dependencies) persist
- Project patterns and conventions remain accessible
- Recent work progress and decisions are preserved
- Failed approaches and solutions are captured for future reference

The hook should focus on systematic extraction rather than ad-hoc summarization, ensuring the most critical project knowledge survives the compaction process.