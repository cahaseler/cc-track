# Plan: 079

Captured: 2025-09-18T15:35:42.604Z

# Test Quality Improvements Plan

## Current State Analysis
‚úÖ **Good news**: 366 tests passing, 7,868 total lines of test code, strong DI pattern already established
üîç **Key issues identified**:
- Inconsistent mock patterns across 28 test files  
- `complete-task.test.ts` is 377 lines and handles multiple concerns
- `stop-review.test.ts` is massive at 1,346 lines
- Manual mock creation scattered throughout files
- Missing integration tests for critical workflows

## Phase 1: Standardize Mock Patterns (Priority: High)
**Problem**: Files like `git-helpers.test.ts` manually create `createMockClaudeSDK()`, while others duplicate similar patterns
**Solution**: 
- Extend existing `src/test-utils/command-mocks.ts` with standardized mock factories
- Add `createMockClaudeSDK()`, `createMockGitHelpers()`, `createMockGitHubHelpers()` 
- Migrate 25+ test files to use centralized mocks
- Remove duplicate mock creation code (~200-300 lines reduction)

## Phase 2: Split Large Test Files (Priority: High)  
**Target files**:
- `complete-task.test.ts` (377 lines) ‚Üí Split into:
  - `complete-task-validation.test.ts` (validation logic)
  - `complete-task-git-flow.test.ts` (git operations)  
  - `complete-task-github.test.ts` (PR creation)
- `stop-review.test.ts` (1,346 lines) ‚Üí Split by concern:
  - `stop-review-validation.test.ts` (change detection)
  - `stop-review-commit.test.ts` (auto-commit logic)
  - `stop-review-claude-integration.test.ts` (review API calls)

## Phase 3: Add Integration Tests (Priority: Medium)
**Critical paths needing integration testing**:
- Complete task workflow: plan capture ‚Üí development ‚Üí validation ‚Üí completion ‚Üí PR
- Git branching workflow: branch creation ‚Üí work ‚Üí merge ‚Üí cleanup  
- Hook integration: multiple hooks working together in sequence
- CLI command integration: commands calling each other

**Approach**: Create `src/integration/` directory with end-to-end workflow tests

## Implementation Strategy
1. **Mock standardization first** - Foundation for everything else
2. **Split files incrementally** - One large file at a time to avoid breaking changes
3. **Add integration tests last** - Build on improved unit test foundation

## Benefits
- **Maintainability**: Centralized mocks eliminate duplication
- **Readability**: Focused test files by concern
- **Coverage**: Integration tests catch workflow breakage
- **Development speed**: Standardized patterns reduce boilerplate

## Risk Mitigation
- All changes preserve existing test coverage (366 tests stay passing)
- Split files maintain same test names/logic, just reorganized  
- Gradual migration allows rollback at each step