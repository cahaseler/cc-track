Summary
- Repository-wide duplicate helper patterns found across commands, hooks, and libs. Primary hotspots: git helpers (repo checks, branch info, WIP detection), CLAUDE.md active task parsing/updating, config access, and validation routines. Centralizing these into shared utilities would reduce drift and simplify tests.

Spec Alignment
- Source specs: .claude/tasks/TASK_026.md (CLI refactor) and .claude/tasks/TASK_027.md (semantic-release + conventional commits). Neither explicitly mandates deduplication post-refactor, but CLAUDE.md and AGENTS.md emphasize parity between original .claude hooks and refactored src/**. The duplicates identified are mostly consequences of the refactor not fully consolidating shared helpers yet.

Behavioral Diffs
- src/commands/statusline.ts implements its own getCurrentBranch whereas src/lib/git-helpers.ts exports getCurrentBranch. Functionally similar today; risk of future drift (e.g., output trimming/encoding or error handling changes) if one changes.
- src/hooks/stop-review.ts re-implements isGitRepository and hasUncommittedChanges despite src/lib/git-helpers.ts exporting the same. Behavior is currently aligned but any bug fix in lib won’t carry automatically.
- Default branch detection logic is duplicated: src/lib/git-helpers.ts#getDefaultBranch and a local implementation in src/commands/complete-task.ts (lines ~372–384). If origin HEAD detection or fallback order changes, behavior will diverge.
- Active task detection and CLAUDE.md access are implemented in multiple places: 
  - src/commands/statusline.ts (getActiveTask)
  - src/hooks/stop-review.ts (private getActiveTask/getActiveTaskId)
  - src/hooks/post-compact.ts (extractActiveTaskFile)
  - src/hooks/capture-plan.ts (updateClaudeMd) and src/commands/complete-task.ts (reverse update to no_active_task.md)
  These all parse/replace the same patterns with subtly different regexes and responsibilities.
- Validation logic appears in two forms:
  - src/hooks/edit-validation.ts: loadEditValidationConfig, runTypeScriptCheck, runBiomeCheck, formatValidationResults
  - src/commands/complete-task.ts: re-reads .claude/track.config.json and runs project-wide TS/Biome/Knip, summarizing counts. Config reading duplicates the path/shape handling from src/lib/config.ts.

Tests & Coverage
- The project has solid tests across src/lib and hooks/commands. However, duplication increases test surface and maintenance:
  - WIP detection exists in both git-session and complete-task; tests would need updating in two places for rule changes.
  - Active task parsing appears in statusline, stop-review, post-compact; behavior changes require multi-point test updates.
  - Config access is tested in src/lib/config.test.ts, but complete-task bypasses that layer, risking inconsistencies not caught by those tests.

Risks
- Behavioral drift: fixing a bug in one duplicate path won’t propagate to the others (git repo detection, default branch selection, CLAUDE.md regexes).
- Inconsistent UX over time: e.g., statusline vs other commands could disagree on branch/task state.
- Harder test maintenance: logic changes require parallel test updates; higher chance of partial fixes.

Required Fixes
1) Consolidate Git helpers
   - Replace local implementations with src/lib/git-helpers.ts in:
     - src/commands/statusline.ts (use getCurrentBranch)
     - src/hooks/stop-review.ts (use isGitRepository, hasUncommittedChanges)
     - src/commands/complete-task.ts (use getDefaultBranch instead of inline try/catch chain)
   - Extract isWipCommit into src/lib/git-helpers.ts (or a small git-session util) and reuse in git-session and complete-task.

2) Centralize CLAUDE.md task parsing/updating
   - Create src/lib/claude-md.ts with:
     - getActiveTaskFile(projectRoot): string | null
     - getActiveTaskTitle(projectRoot): string | null
     - setActiveTask(projectRoot, taskId): void
     - clearActiveTask(projectRoot): void
   - Update statusline, stop-review, post-compact, capture-plan (uses updateClaudeMd today), and complete-task to use these.

3) Standardize config access
   - Update complete-task to consume src/lib/config.ts (getConfig/isHookEnabled/getGitHubConfig) rather than re-parsing .claude/track.config.json. This removes duplicated shape assumptions and leverages existing tests.

4) Share validation utilities
   - Extract runTypeScriptCheck/runBiomeCheck/formatting into src/lib/validation.ts and:
     - Use in edit-validation hook (file-scoped checks)
     - Optionally reuse in complete-task for consistent parsing and messages when running project-scoped checks.

Optional Improvements
- Transcript utilities: pre-compact and stop-review both stream-read JSONL transcripts via readline. Consider src/lib/transcript.ts for shared readers like readRecentMessages and a generic parseEntries to standardize timeouts and error handling.
- Statusline cost/usage: statusline currently shells to ccusage; if reused elsewhere later, extract to src/lib/usage.ts.
- .claude vs src parity: long-term, reduce duplication between .claude/lib/* and src/lib/* by favoring the compiled CLI for all paths, or by having .claude scripts import the shared helpers when executed in a Node/Bun context. This lowers drift between the legacy hooks and the CLI libs.

Concrete Duplication Map
- Git
  - isGitRepository: src/lib/git-helpers.ts vs src/hooks/stop-review.ts
  - hasUncommittedChanges: src/lib/git-helpers.ts vs src/hooks/stop-review.ts
  - getCurrentBranch: src/lib/git-helpers.ts vs src/commands/statusline.ts
  - Default branch detection: src/lib/git-helpers.ts#getDefaultBranch vs inline logic in src/commands/complete-task.ts (lines ~372–384)
  - isWipCommit: duplicated in src/commands/git-session.ts and src/commands/complete-task.ts

- CLAUDE.md active task
  - Parsing: statusline.getActiveTask, stop-review.getActiveTask/getActiveTaskId, post-compact.extractActiveTaskFile
  - Updating: capture-plan.updateClaudeMd (set to new task) vs complete-task (replace with no_active_task.md)

- Config/Validation
  - Config reading: src/lib/config.ts vs direct JSON parsing in src/commands/complete-task.ts
  - Validation routines: edit-validation.ts (TS/Biome parsing + config load) vs complete-task.ts (separate TS/Biome/Knip flow with separate parsing/formatting)

Verified Commands
- ls -la
- rg --files src | wc -l
- rg --files src
- sed -n to inspect specific files
- rg -n to locate occurrences (WIP, CLAUDE.md patterns, git helpers)
- nl -ba src/commands/complete-task.ts | sed -n '300,420p'

Notes for Implementation
- Refactors should be surgical, updating imports and associated tests only where duplication is removed. Avoid changing behavior or messages. Start by introducing the shared modules, then swap call sites incrementally with focused tests.

